name: Publish to PyPI

# Trigger on version tags (e.g., v0.1.0, v1.0.0, v1.2.3)
on:
  push:
    tags:
      - 'v*.*.*'
      - 'v*'

# Ensure only one publish workflow runs at a time
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Build the package
  build-package:
    name: Build distribution package
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Check out the tagged commit
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation
      
      # Step 2: Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      # Step 3: Install build dependencies
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install build twine
      
      # Step 4: Build source distribution and wheel
      - name: Build package
        run: python -m build
      
      # Step 5: Verify package integrity
      - name: Check package metadata
        run: twine check dist/*
      
      # Step 6: Upload built packages as artifacts for the publish job
      - name: Upload distribution artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 7

  # Publish to PyPI
  publish-to-pypi:
    name: Publish package to PyPI
    needs: build-package
    runs-on: ubuntu-latest
    
    environment:
      name: pypi
      url: https://pypi.org/p/aicomp-sdk
    
    permissions:
      id-token: write  # Required for trusted publishing
    
    steps:
      # Step 1: Download the built distributions
      - name: Download distribution artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      
      # Step 2: Publish to PyPI using trusted publishing (recommended)
      # Alternative: Use PYPI_API_TOKEN secret if trusted publishing is not configured
      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          skip-existing: false
          verbose: true

  # Create GitHub Release
  create-github-release:
    name: Create GitHub Release
    needs: publish-to-pypi
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to create releases
    
    steps:
      # Step 1: Check out the repository to access commit history
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Step 2: Download built distributions to attach to release
      - name: Download distribution artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
      
      # Step 3: Extract version from tag
      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
      # Step 4: Generate release notes from CHANGELOG.md or commit history
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          echo "## aicomp-sdk v${VERSION}" > release_notes.md
          echo "" >> release_notes.md
          
          # Try to extract changelog section for this version
          if [ -f CHANGELOG.md ]; then
            echo "### Changes" >> release_notes.md
            # Extract the section for this version from CHANGELOG.md
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' >> release_notes.md || true
          fi
          
          # Add installation instructions
          echo "" >> release_notes.md
          echo "### Installation" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "pip install aicomp-sdk==${VERSION}" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          
          # Add PyPI link
          echo "" >> release_notes.md
          echo "üì¶ [View on PyPI](https://pypi.org/project/aicomp-sdk/${VERSION}/)" >> release_notes.md
          
          cat release_notes.md
      
      # Step 5: Create GitHub Release with artifacts
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release v${{ steps.get_version.outputs.version }}
          body_path: release_notes.md
          files: dist/*
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

  # Notify on success/failure
  notify:
    name: Notify release status
    needs: [build-package, publish-to-pypi, create-github-release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.publish-to-pypi.result }}" == "success" ]; then
            echo "‚úÖ Successfully published aicomp-sdk to PyPI!"
          else
            echo "‚ùå Failed to publish aicomp-sdk to PyPI"
            exit 1
          fi
